<div class="group-sharing-modal">
  <h2 mat-dialog-title>Compartilhar Registro</h2>

  <mat-dialog-content>
    <div class="sharing-section">
      <h3>Informações do Registro</h3>
      <p><strong>Coleção:</strong> {{ data.collection }}</p>
      <p><strong>ID:</strong> {{ data.recordId }}</p>
      <p *ngIf="data.recordName"><strong>Nome:</strong> {{ data.recordName }}</p>
      <p *ngIf="data.currentGroupId"><strong>Grupo Atual:</strong> {{ getGroupName(data.currentGroupId) }}</p>
    </div>

    <div class="form-section">
      <h3>Selecionar Grupo</h3>
      
      <!-- FIX: usar formulário reativo corretamente -->
      <form [formGroup]="sharingForm">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Escolha um grupo</mat-label>
          <mat-select formControlName="selectedGroup" [disabled]="isProcessing">
            <mat-option [value]="null">Nenhum grupo (remover compartilhamento)</mat-option>
            <mat-option *ngFor="let group of groups" [value]="group.id">
              {{ getGroupDisplayName(group) }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </form>
    </div>

    <div class="history-section" *ngIf="sharingHistory.length > 0">
      <h3>Histórico de Compartilhamento</h3>
      <mat-list>
        <mat-list-item *ngFor="let item of sharingHistory">
          <div mat-line><strong>Grupo:</strong> {{ getGroupName(item.groupId) }}</div>
          <div mat-line><strong>Compartilhado em:</strong> {{ getFormattedDate(item.sharedAt) }}</div>
          <div mat-line><strong>Por:</strong> {{ item.sharedBy }}</div>
        </mat-list-item>
      </mat-list>
    </div>

    <div *ngIf="loadingHistory" class="text-center">
      <mat-spinner diameter="30"></mat-spinner>
      <p>Carregando histórico...</p>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()" [disabled]="isProcessing">
      Cancelar
    </button>
    
    <button mat-button color="warn" (click)="onRemoveSharing()" 
            *ngIf="data.currentGroupId" [disabled]="isProcessing">
      <mat-icon *ngIf="isProcessing">hourglass_empty</mat-icon>
      Remover Compartilhamento
    </button>
    
    <button mat-raised-button color="primary" (click)="onShare()" [disabled]="isProcessing">
      <mat-icon *ngIf="isProcessing">hourglass_empty</mat-icon>
      Compartilhar
    </button>
  </mat-dialog-actions>

  <style>
  .full-width {
    width: 100%;
  }

  .sharing-section, .form-section, .history-section {
    margin-bottom: 20px;
  }

  .text-center {
    text-align: center;
    padding: 20px;
  }

  mat-dialog-content {
    min-width: 400px;
    max-height: 500px;
    overflow-y: auto;
  }
  </style>
</div>