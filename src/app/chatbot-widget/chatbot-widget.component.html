<!-- Adicionar √† parte superior do template, fora da div chatbot-container -->
<!-- Popup de Detalhes -->
<div class="details-popup" 
     [ngClass]="{'visible': showDetailsPopup, 'maximized': isDetailsMaximized}" 
     *ngIf="showDetailsPopup && configuracoes.is_admin">
  <div class="details-header">
    <!-- Bot√£o de maximizar √† esquerda -->
    <div class="details-maximize">
      <button class="maximize-button" (click)="toggleDetailsMaximize()">
        <i class="fas" [ngClass]="isDetailsMaximized ? 'fa-compress' : 'fa-expand'"></i>
      </button>
    </div>
    
    <!-- T√≠tulo centralizado -->
    <div class="details-title">
      <span>{{detailsTitle}}</span>
    </div>
    
    <!-- Bot√£o de fechar √† direita -->
    <div class="details-controls">
      <button class="close-button" (click)="showDetailsPopup = false">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  
  <div class="details-body">
    <div class="details-content" *ngIf="detailsData">
      <div class="detail-item" *ngFor="let item of formatRecordDetailsForDisplay(detailsData)">
        <div class="detail-label">{{item.key}}:</div>
        <div class="detail-value">{{item.value}}</div>
      </div>
    </div>
    <div class="no-details" *ngIf="!detailsData">
      <p>Nenhum detalhe dispon√≠vel para exibi√ß√£o.</p>
    </div>
  </div>
</div>

<div class="chatbot-container" 
     [ngClass]="{'minimized': isMinimized, 'maximized': isMaximized, 'dragging': isDragging}" 
     [ngStyle]="!isMinimized ? {'right.px': chatPosition.right, 'bottom.px': chatPosition.bottom} : {}"
     (click)="isMinimized ? toggleChat() : null">
  
  <!-- Atualizar evento mousedown para N√ÉO permitir arrasto no modo maximizado -->
  <div class="chatbot-header" 
       (mousedown)="!isMinimized && !isMaximized ? startDrag($event) : null"
       [ngClass]="{'draggable': !isMinimized && !isMaximized}">
    
    <!-- Bot√£o de maximizar (no lado esquerdo) -->
    <div class="chatbot-maximize" *ngIf="!isMinimized">
      <button class="maximize-button" (click)="$event.stopPropagation(); toggleMaximize()">
        <i class="fas" [ngClass]="isMaximized ? 'fa-compress' : 'fa-expand'"></i>
      </button>
    </div>

    <!-- T√≠tulo (centralizado) com bot√£o de contexto integrado -->
    <div class="chatbot-title">
      <i class="fas fa-robot">ü§ñ</i>
      <span>Chatbot de I.A.</span>
    </div>
    
    <!-- Controles (lado direito) - remover bot√£o de contexto daqui -->
    <div class="chatbot-controls">
      <button class="minimize-button" (click)="$event.stopPropagation(); toggleChat()">
        <i class="fas" [ngClass]="isMinimized ? 'fa-chevron-up' : 'fa-chevron-down'">‚¨áÔ∏è</i>
      </button>
    </div>
  </div>
  
  <div class="chatbot-body" *ngIf="!isMinimized">

    <!-- Indicador de contexto - VERS√ÉO MODIFICADA -->
    <div id="context-indicator" class="context-indicator" *ngIf="showContextIndicator && currentContext && configuracoes.is_admin">
      <!-- Contexto (tipo de visualiza√ß√£o) -->
      <div class="context-pill" *ngIf="currentContext.currentView">
        <span class="context-label">Contexto:</span>
        <span class="context-value">
          {{ currentContext.currentView.type || 'Home' }}
        </span>
      </div>

      
      <!-- Cole√ß√£o - sempre vis√≠vel quando dispon√≠vel, inclusive em list-fichas -->
      <div class="context-pill" *ngIf="currentContext.activeCollection">
        <span class="context-label">Cole√ß√£o:</span>
        <span class="context-value">{{ formatCollectionName(currentContext.activeCollection) }}</span>
      </div>

      <!-- Bal√£o Nome (collection) - modificar para adicionar o evento click -->
      <div class="context-pill" *ngIf="currentContext.currentView?.name" (click)="toggleCollectionDetails()">
        <span class="context-label">Nome:</span>
        <span class="context-value clickable">
          {{ currentContext.currentView?.name || '' }}
        </span>
      </div>
      

      <!-- Bal√£o Ficha (subcollection) - modificar para adicionar o evento click -->
      <div class="context-pill" *ngIf="currentContext.activeSubcollections?.length">
        <span class="context-label">{{ (currentContext.activeSubcollections!.length > 1) ? 'Fichas:' : 'Ficha:' }}</span>
        <span class="context-value">
          <span *ngFor="let subcol of currentContext.activeSubcollections!; let last = last" 
                class="clickable" (click)="toggleSubcollectionDetails(subcol)">
            {{ formatSubcollectionName(subcol) }}
            <!-- Em list-fichas, n√£o mostramos nome de registro espec√≠fico -->
            <span *ngIf="subcol && !isListFichasView() && isSubcollectionView() && 
                        isCurrentSubcollection(subcol) && getSubcollectionRecordName()">
              : {{ getSubcollectionRecordName() }}
            </span>
            {{ !last ? ', ' : '' }}
          </span>
        </span>
      </div>
    </div>
    
    <!-- Verificar a estrutura dos bal√µes de conversa -->
    <div class="messages-container" #messagesContainer (scroll)="onMessagesScroll()">
      <!-- Mensagem de boas-vindas quando n√£o h√° hist√≥rico -->
      <div *ngIf="conversation.length === 0" class="welcome-message">
        <div class="message bot-message">
          <p>Ol√°! Como posso ajudar?</p>
        </div>
      </div>
      
      <!-- Mensagens da conversa -->
      <div *ngFor="let message of conversation" class="message-group">
        <div class="message" [ngClass]="{'user-message': message.sender === 'user', 'bot-message': message.sender === 'bot'}">
          <p>{{ message.content }}</p>
        </div>
      </div>
      
      <!-- Indicador de digita√ß√£o -->
      <div *ngIf="isLoading" class="message-group">
        <div class="message bot-message typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
    
    <div class="input-container">
      <!-- Bot√£o de contexto no lado esquerdo do input -->
      <button class="context-button-bottom" 
              *ngIf="!isMinimized && configuracoes.is_admin"
              (click)="$event.stopPropagation(); toggleContextIndicator()" 
              title="{{showContextIndicator ? 'Ocultar contexto' : 'Mostrar contexto'}}">
        <i class="fas" [ngClass]="showContextIndicator ? 'fa-eye-slash' : 'fa-info-circle'"></i>
      </button>
      
      <input 
        type="text"
        placeholder="Digite sua mensagem..."
        [(ngModel)]="userInput"
        (keyup.enter)="sendMessage()"
        class="message-input"
      >
      <button class="send-button" (click)="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>