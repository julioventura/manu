<div class="container container_principal" [@fadeAnimation]>

  <!-- HEADER -->
  <div class="header">
    <div class="left">
      <img src="https://dentistas.com.br/assets/voltar.png" class="navegacao" (click)="util.voltar()">
      <img src="https://dentistas.com.br/assets/home.png" class="navegacao" (click)="util.goHome()">
    </div>
    <h1 class="title">{{ titulo_da_pagina }}</h1>
    <div class="right">
      <img src="https://dentistas.com.br/assets/editar.png" class="navegacao_direita" (click)="editar()">
      <img src="https://dentistas.com.br/assets/lixo.png" class="navegacao_direita" (click)="excluir()">
    </div>
  </div>
  <div class="record-header">
    {{ subtitulo_da_pagina }}
  </div>
  <!-- HEADER / -->

  <!-- Slider flutuante (sticky) para subcollection -->
  <div class="sticky-slider">
    <div class="width-control">
      <div class="slider-wrapper">
        <label for="labelWidthRange"></label>
        <!-- CORRIGIDO: usar updateCustomLabelWidth com parâmetro -->
        <input type="range" id="labelWidthRange" min="100" max="500" [(ngModel)]="customLabelWidthValue"
          [ngModelOptions]="{standalone: true}" (input)="updateCustomLabelWidth(customLabelWidthValue)">
        <span class="small">{{ customLabelWidthValue }}px</span>
      </div>
    </div>
  </div>

  <!-- Botões das fichas internas -->
  <div *ngIf="show_menu">
    <app-menu [collection]="collection" [id]="id"></app-menu>
  </div>

  <!-- CONTEUDO PRINCIPAL -->
  <div id='00' class="dynamic-form-container" *ngIf="fichaForm && campos && campos.length > 0">

    <!-- Container 1:collections -->
    <form *ngIf="!isLoading && !subcollection" [formGroup]="fichaForm" class="record-details"
      [style.--label-width]="customLabelWidth">

      <div id="01" *ngFor="let campo of campos; trackBy: trackByCampo">
        <!-- CORRIGIDO: usar helpers seguros -->
        <div
          *ngIf="campo.nome === 'nome' || (hasRegistroPropertyByKey(campo.nome) && isNotEmpty(getRegistroPropertyByKey(campo.nome)))"
          class="detail-container">
          <label [for]="campo.nome" class="detail-label">{{ campo.label }}</label>

          <ng-container [ngSwitch]="campo.tipo">
            <!-- URL: campo clicável -->
            <ng-container *ngSwitchCase="'url'">
              <!-- CORRIGIDO: usar helper seguro -->
              <div (click)="openUrl(getFieldString(campo))" style="cursor:pointer;">
                <input type="url" [value]="getFieldString(campo)" class="detail-value url" readonly>
              </div>
            </ng-container>

            <!-- textarea -->
            <ng-container *ngSwitchCase="'textarea'">
              <!-- CORRIGIDO: verificar se formControl existe -->
              <textarea *ngIf="fichaForm.get(campo.nome)" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value" rows="2"
                readonly></textarea>
            </ng-container>

            <!-- text -->
            <ng-container *ngSwitchCase="'text'">
              <!-- CORRIGIDO: usar helper seguro -->
              <ng-container *ngIf="campo.nome === 'nome' && !isNotEmptyField(campo.nome)">
                <input [type]="campo.tipo" [id]="campo.nome" value="(vazio)" class="detail-value" readonly>
              </ng-container>
              <ng-container *ngIf="!(campo.nome === 'nome' && !isNotEmptyField(campo.nome))">
                <input *ngIf="fichaForm.get(campo.nome)" [type]="campo.tipo" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value"
                  readonly>
              </ng-container>
            </ng-container>

            <!-- Demais tipos -->
            <ng-container *ngSwitchDefault>
              <input *ngIf="fichaForm.get(campo.nome)" [type]="campo.tipo" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value" readonly>
            </ng-container>
          </ng-container>
        </div>
      </div>
    </form>

    <!-- Para subcollections -->
    <div id="02" *ngIf="!isLoading && subcollection">
      <form [formGroup]="fichaForm" [style.--label-width]="customLabelWidth">
        <!-- Campos fixos (sem grupo) -->
        <div *ngFor="let campo of fixedFields; trackBy: trackByCampo">
          <div class="detail-container">
            <label [for]="campo.nome" class="detail-label">{{ campo.label }}</label>
            <ng-container [ngSwitch]="campo.tipo">

              <!-- URL -->
              <ng-container *ngSwitchCase="'url'">
                <!-- CORRIGIDO: usar helper seguro -->
                <div (click)="openUrl(getFieldString(campo))" style="cursor:pointer;">
                  <input type="url" [value]="getFieldString(campo)" class="detail-value url" readonly>
                </div>
              </ng-container>

              <!-- Textarea -->
              <ng-container *ngSwitchCase="'textarea'">
                <textarea *ngIf="fichaForm.get(campo.nome)" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value" rows="2"
                  readonly></textarea>
              </ng-container>

              <!-- Checkbox -->
              <ng-container *ngSwitchCase="'checkbox'">
                <input *ngIf="fichaForm.get(campo.nome)" type="checkbox" [formControlName]="campo.nome" [id]="campo.nome" readonly>
              </ng-container>

              <!-- Boolean -->
              <ng-container *ngSwitchCase="'boolean'">
                <input *ngIf="fichaForm.get(campo.nome)" type="checkbox" [formControlName]="campo.nome" [id]="campo.nome" readonly>
              </ng-container>

              <!-- Demais tipos -->
              <ng-container *ngSwitchDefault>
                <input *ngIf="fichaForm.get(campo.nome)" [type]="campo.tipo" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value"
                  readonly>
              </ng-container>
            </ng-container>
          </div>
        </div>

        <!-- Grupo de campos ajustáveis -->
        <div class="full-width-container">
          <div class="record-details" [style.--label-width]="customLabelWidth">
            
            <!-- CORRIGIDO: usar keyValueSortFn e trackByKeyValue -->
            <div *ngFor="let grupo of groupByGrupo(adjustableFields) | keyvalue: keyValueSortFn; trackBy: trackByKeyValue">

              <!-- CORRIGIDO: usar safeCastArray -->
              <ng-container *ngIf="hasNonEmptyField(safeCastArray(grupo.value))">
                <div *ngIf="grupo.key" class="grupo-titulo">
                  {{ grupo.key }}
                </div>

                <!-- CORRIGIDO: usar safeCastArray para subgrupos -->
                <ng-container
                  *ngFor="let subgrupoObj of groupBySubgrupo(safeCastArray(grupo.value)) | keyvalue: keyValueSortFn; trackBy: trackByKeyValue">
                  <!-- Mostrar título do subgrupo apenas se não for vazio e contiver campos não vazios -->
                  <div *ngIf="hasNonEmptyField(safeCastArray(subgrupoObj.value))" class="subgrupo-titulo">
                    {{ subgrupoObj.key }}
                  </div>
                  
                  <!-- CORRIGIDO: iterar sobre campos com segurança -->
                  <div *ngFor="let campo of makeIterable(subgrupoObj.value); trackBy: trackByUnknown" class="campo-container">
                    <!-- CORRIGIDO: verificar se objeto é CampoData válido -->
                    <ng-container *ngIf="isObjectWithNome(campo)">
                      <div class="detail-container">
                        <label [for]="getFieldValueFromKeyValue(campo, 'nome')" class="detail-label">
                          {{ getFieldValueFromKeyValue(campo, 'label') }}
                        </label>
                        <input 
                          [type]="getFieldValueFromKeyValue(campo, 'tipo')" 
                          [id]="getFieldValueFromKeyValue(campo, 'nome')" 
                          [value]="getKeyValueString(campo)" 
                          class="detail-value" 
                          readonly>
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
              </ng-container>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

</div>