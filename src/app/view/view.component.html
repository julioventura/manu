<div class="container container_principal" [@fadeAnimation]>

  <!-- HEADER -->
  <div class="header">
    <div class="left">
      <img src="https://dentistas.com.br/assets/voltar.png" class="navegacao" (click)="util.voltar()">
      <img src="https://dentistas.com.br/assets/home.png" class="navegacao" (click)="util.goHome()">
    </div>
    <h1 class="title">{{ titulo_da_pagina }}</h1>
    <div class="right">
      <img src="https://dentistas.com.br/assets/editar.png" class="navegacao_direita" (click)="editar()">
      <!-- CORRIGIDO: usar canShareRecord em vez de canShare() -->
      <img 
        *ngIf="canShareRecord" 
        src="https://dentistas.com.br/assets/compartilhar.png" 
        class="navegacao_direita" 
        (click)="openSharingModal()"
        title="Compartilhar com grupo">
      <img src="https://dentistas.com.br/assets/lixo.png" class="navegacao_direita" (click)="excluir()">
    </div>
  </div>
  <div class="record-header">
    {{ subtitulo_da_pagina }}
  </div>
  <!-- HEADER / -->

  <!-- Slider flutuante (sticky) para subcollection -->
  <div class="sticky-slider">
    <div class="width-control">
      <div class="slider-wrapper">
        <label for="labelWidthRange"></label>
        <!-- CORRIGIDO: usar updateCustomLabelWidth com parâmetro -->
        <input type="range" id="labelWidthRange" min="100" max="500" [(ngModel)]="customLabelWidthValue"
          [ngModelOptions]="{standalone: true}" (input)="updateCustomLabelWidth(customLabelWidthValue)">
        <span class="small">{{ customLabelWidthValue }}px</span>
      </div>
    </div>
  </div>

  <!-- Botões das fichas internas -->
  <div *ngIf="show_menu">
    <app-menu [collection]="collection" [id]="id"></app-menu>
  </div>

  <!-- CONTEUDO PRINCIPAL -->
  <div id='00' class="dynamic-form-container" *ngIf="fichaForm && campos && campos.length > 0">

    <!-- Container 1:collections -->
    <form *ngIf="!isLoading && !subcollection" [formGroup]="fichaForm" class="record-details"
      [style.--label-width]="customLabelWidth">

      <div id="01" *ngFor="let campo of campos; trackBy: trackByCampo">
        <!-- CORRIGIDO: usar helpers seguros -->
        <div
          *ngIf="campo.nome === 'nome' || (hasRegistroPropertyByKey(campo.nome) && isNotEmpty(getRegistroPropertyByKey(campo.nome)))"
          class="detail-container">
          <label [for]="campo.nome" class="detail-label">{{ campo.label }}</label>

          <ng-container [ngSwitch]="campo.tipo">
            <!-- URL: campo clicável -->
            <ng-container *ngSwitchCase="'url'">
              <!-- CORRIGIDO: usar helper seguro -->
              <div (click)="openUrl(getFieldString(campo))" style="cursor:pointer;">
                <input type="url" [value]="getFieldString(campo)" class="detail-value url" readonly>
              </div>
            </ng-container>

            <!-- textarea -->
            <ng-container *ngSwitchCase="'textarea'">
              <!-- CORRIGIDO: verificar se formControl existe -->
              <textarea *ngIf="fichaForm.get(campo.nome)" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value" rows="2"
                readonly></textarea>
            </ng-container>

            <!-- text -->
            <ng-container *ngSwitchCase="'text'">
              <!-- CORRIGIDO: usar helper seguro -->
              <ng-container *ngIf="campo.nome === 'nome' && !isNotEmptyField(campo.nome)">
                <input [type]="campo.tipo" [id]="campo.nome" value="(vazio)" class="detail-value" readonly>
              </ng-container>
              <ng-container *ngIf="!(campo.nome === 'nome' && !isNotEmptyField(campo.nome))">
                <input *ngIf="fichaForm.get(campo.nome)" [type]="campo.tipo" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value"
                  readonly>
              </ng-container>
            </ng-container>

            <!-- Demais tipos -->
            <ng-container *ngSwitchDefault>
              <input *ngIf="fichaForm.get(campo.nome)" [type]="campo.tipo" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value" readonly>
            </ng-container>
          </ng-container>
        </div>
      </div>
    </form>

    <!-- Para subcollections -->
    <div id="02" *ngIf="!isLoading && subcollection">
      <form [formGroup]="fichaForm" [style.--label-width]="customLabelWidth">
        <!-- Campos fixos (sem grupo) -->
        <div *ngFor="let campo of fixedFields; trackBy: trackByCampo">
          <div class="detail-container">
            <label [for]="campo.nome" class="detail-label">{{ campo.label }}</label>
            <ng-container [ngSwitch]="campo.tipo">

              <!-- URL -->
              <ng-container *ngSwitchCase="'url'">
                <!-- CORRIGIDO: usar helper seguro -->
                <div (click)="openUrl(getFieldString(campo))" style="cursor:pointer;">
                  <input type="url" [value]="getFieldString(campo)" class="detail-value url" readonly>
                </div>
              </ng-container>

              <!-- Textarea -->
              <ng-container *ngSwitchCase="'textarea'">
                <textarea *ngIf="fichaForm.get(campo.nome)" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value" rows="2"
                  readonly></textarea>
              </ng-container>

              <!-- Checkbox -->
              <ng-container *ngSwitchCase="'checkbox'">
                <input *ngIf="fichaForm.get(campo.nome)" type="checkbox" [formControlName]="campo.nome" [id]="campo.nome" readonly>
              </ng-container>

              <!-- Boolean -->
              <ng-container *ngSwitchCase="'boolean'">
                <input *ngIf="fichaForm.get(campo.nome)" type="checkbox" [formControlName]="campo.nome" [id]="campo.nome" readonly>
              </ng-container>

              <!-- Demais tipos -->
              <ng-container *ngSwitchDefault>
                <input *ngIf="fichaForm.get(campo.nome)" [type]="campo.tipo" [formControlName]="campo.nome" [id]="campo.nome" class="detail-value"
                  readonly>
              </ng-container>
            </ng-container>
          </div>
        </div>

        <!-- Grupo de campos ajustáveis -->
        <div class="full-width-container">
          <div class="record-details" [style.--label-width]="customLabelWidth">
            
            <!-- CORRIGIDO: usar keyValueSortFn e trackByKeyValue -->
            <div *ngFor="let grupo of groupByGrupo(adjustableFields) | keyvalue: keyValueSortFn; trackBy: trackByKeyValue">

              <!-- CORRIGIDO: usar safeCastArray -->
              <ng-container *ngIf="hasNonEmptyField(safeCastArray(grupo.value))">
                <div *ngIf="grupo.key" class="grupo-titulo">
                  {{ grupo.key }}
                </div>

                <!-- CORRIGIDO: usar safeCastArray para subgrupos -->
                <ng-container
                  *ngFor="let subgrupoObj of groupBySubgrupo(safeCastArray(grupo.value)) | keyvalue: keyValueSortFn; trackBy: trackByKeyValue">
                  <!-- Mostrar título do subgrupo apenas se não for vazio e contiver campos não vazios -->
                  <div *ngIf="hasNonEmptyField(safeCastArray(subgrupoObj.value))" class="subgrupo-titulo">
                    {{ subgrupoObj.key }}
                  </div>
                  
                  <!-- CORRIGIDO: iterar sobre campos com segurança -->
                  <div *ngFor="let campo of makeIterable(subgrupoObj.value); trackBy: trackByUnknown" class="campo-container">
                    <!-- CORRIGIDO: verificar se objeto é CampoData válido -->
                    <ng-container *ngIf="campo && typeof campo === 'object' && campo['nome']">
                      <div class="detail-container">
                        <label [for]="safeString(campo['nome'])" class="detail-label">{{ safeString(campo['label']) }}</label>
                        <!-- CORRIGIR: usar campo como objeto Campo, não string -->
                        <input [type]="safeString(campo['tipo'])" [id]="safeString(campo['nome'])" 
                               [value]="getKeyValueString(campo)" class="detail-value" readonly>
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
              </ng-container>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- For the group-sharing section -->
  <!-- CORRIGIDO: usar helper seguro para groupId -->
  <div class="group-sharing-container" *ngIf="registro">
    <h3 class="section-title">Compartilhamento</h3>
    <app-group-sharing 
      [recordGroupId]="safeGetGroupId()" 
      [collection]="collection" 
      [recordId]="id"
      (groupIdChange)="onGroupIdChanged()">
    </app-group-sharing>
    <!-- Botão para salvar alterações de compartilhamento -->
    <div class="group-save-actions" *ngIf="groupChanged">
      <button mat-raised-button color="primary" (click)="saveGroupChange()">
        <mat-icon>save</mat-icon>
        Salvar alterações de compartilhamento
      </button>
    </div>
  </div>

  <!-- CORRIGIDO: usar helper seguro para histórico -->
  <div class="sharing-history-section" *ngIf="sharingHistory && sharingHistory.length > 0">
    <h3>Histórico de Compartilhamento</h3>
    <mat-list>
      <mat-list-item *ngFor="let entry of sharingHistory">
        <mat-icon mat-list-icon [ngClass]="{
          'share-icon': !safeString(entry.previousGroupId) && safeString(entry.groupId),
          'unshare-icon': safeString(entry.previousGroupId) && !safeString(entry.groupId),
          'change-icon': safeString(entry.previousGroupId) && safeString(entry.groupId)
        }">
          {{ !safeString(entry.previousGroupId) && safeString(entry.groupId) ? 'share' :
          (safeString(entry.previousGroupId) && !safeString(entry.groupId) ? 'link_off' : 'swap_horiz') }}
        </mat-icon>
        <div mat-line>
          <!-- CORRIGIDO: usar helpers seguros -->
          <ng-container *ngIf="!safeString(entry.previousGroupId) && safeString(entry.groupId)">
            Compartilhado com <strong>{{ getGroupName(safeString(entry.groupId)) }}</strong>
          </ng-container>
          <ng-container *ngIf="safeString(entry.previousGroupId) && !safeString(entry.groupId)">
            Removido compartilhamento com <strong>{{ getGroupName(safeString(entry.previousGroupId)) }}</strong>
          </ng-container>
          <ng-container *ngIf="safeString(entry.previousGroupId) && safeString(entry.groupId)">
            Alterado compartilhamento de <strong>{{ getGroupName(safeString(entry.previousGroupId)) }}</strong>
            para <strong>{{ getGroupName(safeString(entry.groupId)) }}</strong>
          </ng-container>
        </div>
        <div mat-line class="history-metadata">
          {{ formatDate(entry.timestamp) }} por {{ safeString(entry.userName) || safeString(entry.userId) || 'Usuário desconhecido' }}
        </div>
      </mat-list-item>
    </mat-list>
  </div>

</div>